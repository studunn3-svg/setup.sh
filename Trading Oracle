#!/bin/bash
# ============================================================
# Trading Oracle – Full GitHub-Ready Deployable Setup
# ============================================================

set -e
mkdir -p trading-oracle/{mobile/dist,deploy/nginx,.github/workflows}
cd trading-oracle

# ------------------------------------------------------------
# Dockerfile
# ------------------------------------------------------------
cat <<'EOF' > Dockerfile
FROM nginx:stable-alpine
COPY deploy/nginx/trading-oracle.conf /etc/nginx/conf.d/default.conf
COPY mobile/dist /usr/share/nginx/html
HEALTHCHECK --interval=30s --timeout=3s --retries=3 CMD wget -q -O - http://127.0.0.1/ || exit 1
EXPOSE 80
CMD ["nginx","-g","daemon off;"]
EOF

# ------------------------------------------------------------
# .dockerignore
# ------------------------------------------------------------
cat <<'EOF' > .dockerignore
**/.git
**/.gitignore
**/.DS_Store
**/node_modules
**/build
**/.expo
**/android
**/ios
**/cypress
**/*.map
deploy/nginx/docker-compose.yml
README_DEPLOY.md
serve-static.js
EOF

# ------------------------------------------------------------
# deploy/nginx/trading-oracle.conf
# ------------------------------------------------------------
cat <<'EOF' > deploy/nginx/trading-oracle.conf
server {
  listen 80 default_server;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;
  add_header Permissions-Policy "geolocation=(), camera=(), microphone=()" always;
  add_header Cache-Control "no-transform" always;

  location / { try_files $uri /index.html; }
  location = /privacy    { try_files /privacy.html =404; }
  location = /terms      { try_files /terms.html =404; }
  location = /disclaimer { try_files /disclaimer.html =404; }

  location ~* \.(?:png|jpe?g|gif|svg|webp|ico|css|js)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }
  location ~* \.(?:html)$ {
    add_header Cache-Control "public, max-age=600";
    try_files $uri =404;
  }
}
EOF

# ------------------------------------------------------------
# deploy/nginx/docker-compose.yml
# ------------------------------------------------------------
cat <<'EOF' > deploy/nginx/docker-compose.yml
version: "3.9"
services:
  nginx:
    image: nginx:stable-alpine
    container_name: trading-oracle-web
    ports:
      - "80:80"
    volumes:
      - ./trading-oracle.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../mobile/dist:/usr/share/nginx/html:ro
    restart: unless-stopped
EOF

# ------------------------------------------------------------
# serve-static.js
# ------------------------------------------------------------
cat <<'EOF' > serve-static.js
const express = require('express');
const path = require('path');
const app = express();
const root = path.join(__dirname, 'mobile', 'dist');
app.use(express.static(root));
app.get('/privacy', (req,res)=> res.sendFile(path.join(root,'privacy.html')));
app.get('/terms', (req,res)=> res.sendFile(path.join(root,'terms.html')));
app.get('/disclaimer', (req,res)=> res.sendFile(path.join(root,'disclaimer.html')));
app.get('*', (req,res)=> res.sendFile(path.join(root,'index.html')));
const port = process.env.PORT || 80;
app.listen(port, ()=> console.log(`✅ Trading Oracle served at http://localhost:${port}`));
EOF

# ------------------------------------------------------------
# .github/workflows/docker-static-site.yml
# ------------------------------------------------------------
cat <<'EOF' > .github/workflows/docker-static-site.yml
name: Build & Publish Static Site Image

on:
  push:
    branches: [ main ]
    paths:
      - 'mobile/dist/**'
      - 'deploy/nginx/trading-oracle.conf'
      - 'Dockerfile'
      - '.github/workflows/docker-static-site.yml'
  workflow_dispatch: {}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tags
        id: meta
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(basename "${{ github.repository }}")
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "sha_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build & push to GHCR
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.owner_lower }}/${{ steps.meta.outputs.repo_name }}-web:${{ steps.meta.outputs.sha_tag }}
            ghcr.io/${{ steps.meta.outputs.owner_lower }}/${{ steps.meta.outputs.repo_name }}-web:latest
EOF

# ------------------------------------------------------------
# README_DEPLOY.md
# ------------------------------------------------------------
cat <<'EOF' > README_DEPLOY.md
# Trading Oracle – Store-ready (Enhanced)

Deployable web/mobile frontend served with NGINX or Node.js.

### Local Test (NGINX)
```bash
cd deploy/nginx
docker compose up -d
# Visit http://localhost
